{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Users\\snntv\\OneDrive\\Documents\\AI Agent\\projects\\Meteor\\BlueSky\\packages\\mongo\\oplog_tailing.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","topLevelAwait","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/mongo/oplog_tailing.ts","filename":"C:\\Users\\snntv\\OneDrive\\Documents\\AI Agent\\projects\\Meteor\\BlueSky\\packages\\mongo\\oplog_tailing.ts","inputSourceMap":{"version":3,"file":"packages/mongo/oplog_tailing.ts","sourceRoot":"","sources":["packages/mongo/oplog_tailing.ts"],"names":[],"mappings":"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","sourcesContent":["import isEmpty from 'lodash.isempty';\nimport { Meteor } from 'meteor/meteor';\nimport { CursorDescription } from './cursor_description';\nimport { MongoConnection } from './mongo_connection';\n\nimport { NpmModuleMongodb } from \"meteor/npm-mongo\";\nconst { Long } = NpmModuleMongodb;\n\nexport const OPLOG_COLLECTION = 'oplog.rs';\n\nlet TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\nconst TAIL_TIMEOUT = +(process.env.METEOR_OPLOG_TAIL_TIMEOUT || 30000);\n\nexport interface OplogEntry {\n  op: string;\n  o: any;\n  o2?: any;\n  ts: any;\n  ns: string;\n}\n\nexport interface CatchingUpResolver {\n  ts: any;\n  resolver: () => void;\n}\n\nexport interface OplogTrigger {\n  dropCollection: boolean;\n  dropDatabase: boolean;\n  op: OplogEntry;\n  collection?: string;\n  id?: string | null;\n}\n\nexport class OplogHandle {\n  private _oplogUrl: string;\n  public _dbName: string;\n  private _oplogLastEntryConnection: MongoConnection | null;\n  private _oplogTailConnection: MongoConnection | null;\n  private _oplogOptions: {\n    excludeCollections?: string[];\n    includeCollections?: string[];\n  };\n  private _stopped: boolean;\n  private _tailHandle: any;\n  private _readyPromiseResolver: (() => void) | null;\n  private _readyPromise: Promise<void>;\n  public _crossbar: any;\n  private _catchingUpResolvers: CatchingUpResolver[];\n  private _lastProcessedTS: any;\n  private _onSkippedEntriesHook: any;\n  private _startTrailingPromise: Promise<void>;\n  private _resolveTimeout: any;\n\n  private _entryQueue = new Meteor._DoubleEndedQueue();\n  private _workerActive = false;\n  private _workerPromise: Promise<void> | null = null;\n\n  constructor(oplogUrl: string, dbName: string) {\n    this._oplogUrl = oplogUrl;\n    this._dbName = dbName;\n\n    this._resolveTimeout = null;\n    this._oplogLastEntryConnection = null;\n    this._oplogTailConnection = null;\n    this._stopped = false;\n    this._tailHandle = null;\n    this._readyPromiseResolver = null;\n    this._readyPromise = new Promise(r => this._readyPromiseResolver = r); \n    this._crossbar = new DDPServer._Crossbar({\n      factPackage: \"mongo-livedata\", factName: \"oplog-watchers\"\n    });\n\n    const includeCollections =\n      Meteor.settings?.packages?.mongo?.oplogIncludeCollections;\n    const excludeCollections =\n      Meteor.settings?.packages?.mongo?.oplogExcludeCollections;\n    if (includeCollections?.length && excludeCollections?.length) {\n      throw new Error(\n        \"Can't use both mongo oplog settings oplogIncludeCollections and oplogExcludeCollections at the same time.\"\n      );\n    }\n    this._oplogOptions = { includeCollections, excludeCollections };\n\n    this._catchingUpResolvers = [];\n    this._lastProcessedTS = null;\n\n    this._onSkippedEntriesHook = new Hook({\n      debugPrintExceptions: \"onSkippedEntries callback\"\n    });\n\n    this._startTrailingPromise = this._startTailing();\n  }\n\n  private _getOplogSelector(lastProcessedTS?: any): any {\n    const oplogCriteria: any = [\n      {\n        $or: [\n          { op: { $in: [\"i\", \"u\", \"d\"] } },\n          { op: \"c\", \"o.drop\": { $exists: true } },\n          { op: \"c\", \"o.dropDatabase\": 1 },\n          { op: \"c\", \"o.applyOps\": { $exists: true } },\n        ],\n      },\n    ];\n\n    const nsRegex = new RegExp(\n      \"^(?:\" +\n        [\n          // @ts-ignore\n          Meteor._escapeRegExp(this._dbName + \".\"),\n          // @ts-ignore\n          Meteor._escapeRegExp(\"admin.$cmd\"),\n        ].join(\"|\") +\n        \")\"\n    );\n\n    if (this._oplogOptions.excludeCollections?.length) {\n      oplogCriteria.push({\n        ns: {\n          $regex: nsRegex,\n          $nin: this._oplogOptions.excludeCollections.map(\n            (collName: string) => `${this._dbName}.${collName}`\n          ),\n        },\n      });\n    } else if (this._oplogOptions.includeCollections?.length) {\n      oplogCriteria.push({\n        $or: [\n          { ns: /^admin\\.\\$cmd/ },\n          {\n            ns: {\n              $in: this._oplogOptions.includeCollections.map(\n                (collName: string) => `${this._dbName}.${collName}`\n              ),\n            },\n          },\n        ],\n      });\n    } else {\n      oplogCriteria.push({\n        ns: nsRegex,\n      });\n    }\n    if(lastProcessedTS) {\n      oplogCriteria.push({\n        ts: { $gt: lastProcessedTS },\n      });\n    }\n\n    return {\n      $and: oplogCriteria,\n    };\n  }\n\n  async stop(): Promise<void> {\n    if (this._stopped) return;\n    this._stopped = true;\n    if (this._tailHandle) {\n      await this._tailHandle.stop();\n    }\n  }\n\n  async _onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    if (this._stopped) {\n      throw new Error(\"Called onOplogEntry on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    const originalCallback = callback;\n\n    /**\n     * This depends on AsynchronousQueue tasks being wrapped in `bindEnvironment` too.\n     *\n     * @todo Check after we simplify the `bindEnvironment` implementation if we can remove the second wrap.\n     */\n    callback = Meteor.bindEnvironment(\n      function (notification: any) {\n        originalCallback(notification);\n      },\n      // @ts-ignore\n      function (err) {\n        Meteor._debug(\"Error in oplog callback\", err);\n      }\n    );\n\n    const listenHandle = this._crossbar.listen(trigger, callback);\n    return {\n      stop: async function () {\n        await listenHandle.stop();\n      }\n    };\n  }\n\n  onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    return this._onOplogEntry(trigger, callback);\n  }\n\n  onSkippedEntries(callback: Function): { stop: () => void } {\n    if (this._stopped) {\n      throw new Error(\"Called onSkippedEntries on stopped handle!\");\n    }\n    return this._onSkippedEntriesHook.register(callback);\n  }\n\n  async _waitUntilCaughtUp(): Promise<void> {\n    if (this._stopped) {\n      throw new Error(\"Called waitUntilCaughtUp on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    let lastEntry: OplogEntry | null = null;\n\n    while (!this._stopped) {\n      const oplogSelector = this._getOplogSelector();\n      try {\n        lastEntry = await this._oplogLastEntryConnection.findOneAsync(\n          OPLOG_COLLECTION,\n          oplogSelector,\n          { projection: { ts: 1 }, sort: { $natural: -1 } }\n        );\n        break;\n      } catch (e) {\n        Meteor._debug(\"Got exception while reading last entry\", e);\n        // @ts-ignore\n        await Meteor.sleep(100);\n      }\n    }\n\n    if (this._stopped) return;\n\n    if (!lastEntry) return;\n\n    const ts = lastEntry.ts;\n    if (!ts) {\n      throw Error(\"oplog entry without ts: \" + JSON.stringify(lastEntry));\n    }\n\n    if (this._lastProcessedTS && ts.lessThanOrEqual(this._lastProcessedTS)) {\n      return;\n    }\n\n    let insertAfter = this._catchingUpResolvers.length;\n\n    while (insertAfter - 1 > 0 && this._catchingUpResolvers[insertAfter - 1].ts.greaterThan(ts)) {\n      insertAfter--;\n    }\n\n    let promiseResolver = null;\n\n    const promiseToAwait = new Promise(r => promiseResolver = r);\n\n    clearTimeout(this._resolveTimeout);\n\n    this._resolveTimeout = setTimeout(() => {\n      console.error(\"Meteor: oplog catching up took too long\", { ts });\n    }, 10000);\n\n    this._catchingUpResolvers.splice(insertAfter, 0, { ts, resolver: promiseResolver! });\n\n    await promiseToAwait;\n\n    clearTimeout(this._resolveTimeout);\n  }\n\n  async waitUntilCaughtUp(): Promise<void> {\n    return this._waitUntilCaughtUp();\n  }\n\n  async _startTailing(): Promise<void> {\n    const mongodbUri = require('mongodb-uri');\n    if (mongodbUri.parse(this._oplogUrl).database !== 'local') {\n      throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n    }\n\n    this._oplogTailConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n    this._oplogLastEntryConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n\n    try {\n      const isMasterDoc = await this._oplogLastEntryConnection!.db\n        .admin()\n        .command({ ismaster: 1 });\n\n      if (!(isMasterDoc && isMasterDoc.setName)) {\n        throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n      }\n\n      const lastOplogEntry = await this._oplogLastEntryConnection.findOneAsync(\n        OPLOG_COLLECTION,\n        {},\n        { sort: { $natural: -1 }, projection: { ts: 1 } }\n      );\n\n      const oplogSelector = this._getOplogSelector(lastOplogEntry?.ts);\n      if (lastOplogEntry) {\n        this._lastProcessedTS = lastOplogEntry.ts;\n      }\n\n      const cursorDescription = new CursorDescription(\n        OPLOG_COLLECTION,\n        oplogSelector,\n        { tailable: true }\n      );\n\n      this._tailHandle = this._oplogTailConnection.tail(\n        cursorDescription,\n        (doc: any) => {\n          this._entryQueue.push(doc);\n          this._maybeStartWorker();\n        },\n        TAIL_TIMEOUT\n      );\n\n      this._readyPromiseResolver!();\n    } catch (error) {\n      console.error('Error in _startTailing:', error);\n      throw error;\n    }\n  }\n\n  private _maybeStartWorker(): void {\n    if (this._workerPromise) return;\n    this._workerActive = true;\n\n    // Convert to a proper promise-based queue processor\n    this._workerPromise = (async () => {\n      try {\n        while (!this._stopped && !this._entryQueue.isEmpty()) {\n          // Are we too far behind? Just tell our observers that they need to\n          // repoll, and drop our queue.\n          if (this._entryQueue.length > TOO_FAR_BEHIND) {\n            const lastEntry = this._entryQueue.pop();\n            this._entryQueue.clear();\n\n            this._onSkippedEntriesHook.each((callback: Function) => {\n              callback();\n              return true;\n            });\n\n            // Free any waitUntilCaughtUp() calls that were waiting for us to\n            // pass something that we just skipped.\n            this._setLastProcessedTS(lastEntry.ts);\n            continue;\n          }\n\n          // Process next batch from the queue\n          const doc = this._entryQueue.shift();\n\n          try {\n            await handleDoc(this, doc);\n            // Process any waiting fence callbacks\n            if (doc.ts) {\n              this._setLastProcessedTS(doc.ts);\n            }\n          } catch (e) {\n            // Keep processing queue even if one entry fails\n            console.error('Error processing oplog entry:', e);\n          }\n        }\n      } finally {\n        this._workerPromise = null;\n        this._workerActive = false;\n      }\n    })();\n  }\n\n  _setLastProcessedTS(ts: any): void {\n    this._lastProcessedTS = ts;\n    while (!isEmpty(this._catchingUpResolvers) && this._catchingUpResolvers[0].ts.lessThanOrEqual(this._lastProcessedTS)) {\n      const sequencer = this._catchingUpResolvers.shift()!;\n      sequencer.resolver();\n    }\n  }\n\n  _defineTooFarBehind(value: number): void {\n    TOO_FAR_BEHIND = value;\n  }\n\n  _resetTooFarBehind(): void {\n    TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\n  }\n}\n\nexport function idForOp(op: OplogEntry): string {\n  if (op.op === 'd' || op.op === 'i') {\n    return op.o._id;\n  } else if (op.op === 'u') {\n    return op.o2._id;\n  } else if (op.op === 'c') {\n    throw Error(\"Operator 'c' doesn't supply an object with id: \" + JSON.stringify(op));\n  } else {\n    throw Error(\"Unknown op: \" + JSON.stringify(op));\n  }\n}\n\nasync function handleDoc(handle: OplogHandle, doc: OplogEntry): Promise<void> {\n  if (doc.ns === \"admin.$cmd\") {\n    if (doc.o.applyOps) {\n      // This was a successful transaction, so we need to apply the\n      // operations that were involved.\n      let nextTimestamp = doc.ts;\n      for (const op of doc.o.applyOps) {\n        // See https://github.com/meteor/meteor/issues/10420.\n        if (!op.ts) {\n          op.ts = nextTimestamp;\n          nextTimestamp = nextTimestamp.add(Long.ONE);\n        }\n        await handleDoc(handle, op);\n      }\n      return;\n    }\n    throw new Error(\"Unknown command \" + JSON.stringify(doc));\n  }\n\n  const trigger: OplogTrigger = {\n    dropCollection: false,\n    dropDatabase: false,\n    op: doc,\n  };\n\n  if (typeof doc.ns === \"string\" && doc.ns.startsWith(handle._dbName + \".\")) {\n    trigger.collection = doc.ns.slice(handle._dbName.length + 1);\n  }\n\n  // Is it a special command and the collection name is hidden\n  // somewhere in operator?\n  if (trigger.collection === \"$cmd\") {\n    if (doc.o.dropDatabase) {\n      delete trigger.collection;\n      trigger.dropDatabase = true;\n    } else if (\"drop\" in doc.o) {\n      trigger.collection = doc.o.drop;\n      trigger.dropCollection = true;\n      trigger.id = null;\n    } else if (\"create\" in doc.o && \"idIndex\" in doc.o) {\n      // A collection got implicitly created within a transaction. There's\n      // no need to do anything about it.\n    } else {\n      throw Error(\"Unknown command \" + JSON.stringify(doc));\n    }\n  } else {\n    // All other ops have an id.\n    trigger.id = idForOp(doc);\n  }\n\n  await handle._crossbar.fire(trigger);\n\n  await new Promise(resolve => setImmediate(resolve));\n}"]},"targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"production","cwd":"C:\\Users\\snntv\\OneDrive\\Documents\\AI Agent\\projects\\Meteor\\BlueSky","root":"C:\\Users\\snntv\\OneDrive\\Documents\\AI Agent\\projects\\Meteor\\BlueSky","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true,"topLevelAwait":true},"externalDependencies":[]},{"key":"transform-runtime","visitor":{"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.17.2","helpers":true,"useESModules":false,"corejs":false},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true},"externalDependencies":[]},{"key":"transform-react-jsx","visitor":{"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXFragment":{"exit":[null]},"JSXElement":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false},"externalDependencies":[]},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-nullish-coalescing-operator","visitor":{"LogicalExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-chaining","visitor":{"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-optional-catch-binding","visitor":{"CatchClause":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-class-properties","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-async-generator-functions","visitor":{"Program":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"proposal-logical-assignment-operators","visitor":{"AssignmentExpression":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{},"externalDependencies":[]},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{},"externalDependencies":[]}],"presets":[],"generatorOpts":{"filename":"C:\\Users\\snntv\\OneDrive\\Documents\\AI Agent\\projects\\Meteor\\BlueSky\\packages\\mongo\\oplog_tailing.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mongo/oplog_tailing.ts","inputSourceMap":{"version":3,"file":"packages/mongo/oplog_tailing.ts","sourceRoot":"","sources":["packages/mongo/oplog_tailing.ts"],"names":[],"mappings":"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","sourcesContent":["import isEmpty from 'lodash.isempty';\nimport { Meteor } from 'meteor/meteor';\nimport { CursorDescription } from './cursor_description';\nimport { MongoConnection } from './mongo_connection';\n\nimport { NpmModuleMongodb } from \"meteor/npm-mongo\";\nconst { Long } = NpmModuleMongodb;\n\nexport const OPLOG_COLLECTION = 'oplog.rs';\n\nlet TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\nconst TAIL_TIMEOUT = +(process.env.METEOR_OPLOG_TAIL_TIMEOUT || 30000);\n\nexport interface OplogEntry {\n  op: string;\n  o: any;\n  o2?: any;\n  ts: any;\n  ns: string;\n}\n\nexport interface CatchingUpResolver {\n  ts: any;\n  resolver: () => void;\n}\n\nexport interface OplogTrigger {\n  dropCollection: boolean;\n  dropDatabase: boolean;\n  op: OplogEntry;\n  collection?: string;\n  id?: string | null;\n}\n\nexport class OplogHandle {\n  private _oplogUrl: string;\n  public _dbName: string;\n  private _oplogLastEntryConnection: MongoConnection | null;\n  private _oplogTailConnection: MongoConnection | null;\n  private _oplogOptions: {\n    excludeCollections?: string[];\n    includeCollections?: string[];\n  };\n  private _stopped: boolean;\n  private _tailHandle: any;\n  private _readyPromiseResolver: (() => void) | null;\n  private _readyPromise: Promise<void>;\n  public _crossbar: any;\n  private _catchingUpResolvers: CatchingUpResolver[];\n  private _lastProcessedTS: any;\n  private _onSkippedEntriesHook: any;\n  private _startTrailingPromise: Promise<void>;\n  private _resolveTimeout: any;\n\n  private _entryQueue = new Meteor._DoubleEndedQueue();\n  private _workerActive = false;\n  private _workerPromise: Promise<void> | null = null;\n\n  constructor(oplogUrl: string, dbName: string) {\n    this._oplogUrl = oplogUrl;\n    this._dbName = dbName;\n\n    this._resolveTimeout = null;\n    this._oplogLastEntryConnection = null;\n    this._oplogTailConnection = null;\n    this._stopped = false;\n    this._tailHandle = null;\n    this._readyPromiseResolver = null;\n    this._readyPromise = new Promise(r => this._readyPromiseResolver = r); \n    this._crossbar = new DDPServer._Crossbar({\n      factPackage: \"mongo-livedata\", factName: \"oplog-watchers\"\n    });\n\n    const includeCollections =\n      Meteor.settings?.packages?.mongo?.oplogIncludeCollections;\n    const excludeCollections =\n      Meteor.settings?.packages?.mongo?.oplogExcludeCollections;\n    if (includeCollections?.length && excludeCollections?.length) {\n      throw new Error(\n        \"Can't use both mongo oplog settings oplogIncludeCollections and oplogExcludeCollections at the same time.\"\n      );\n    }\n    this._oplogOptions = { includeCollections, excludeCollections };\n\n    this._catchingUpResolvers = [];\n    this._lastProcessedTS = null;\n\n    this._onSkippedEntriesHook = new Hook({\n      debugPrintExceptions: \"onSkippedEntries callback\"\n    });\n\n    this._startTrailingPromise = this._startTailing();\n  }\n\n  private _getOplogSelector(lastProcessedTS?: any): any {\n    const oplogCriteria: any = [\n      {\n        $or: [\n          { op: { $in: [\"i\", \"u\", \"d\"] } },\n          { op: \"c\", \"o.drop\": { $exists: true } },\n          { op: \"c\", \"o.dropDatabase\": 1 },\n          { op: \"c\", \"o.applyOps\": { $exists: true } },\n        ],\n      },\n    ];\n\n    const nsRegex = new RegExp(\n      \"^(?:\" +\n        [\n          // @ts-ignore\n          Meteor._escapeRegExp(this._dbName + \".\"),\n          // @ts-ignore\n          Meteor._escapeRegExp(\"admin.$cmd\"),\n        ].join(\"|\") +\n        \")\"\n    );\n\n    if (this._oplogOptions.excludeCollections?.length) {\n      oplogCriteria.push({\n        ns: {\n          $regex: nsRegex,\n          $nin: this._oplogOptions.excludeCollections.map(\n            (collName: string) => `${this._dbName}.${collName}`\n          ),\n        },\n      });\n    } else if (this._oplogOptions.includeCollections?.length) {\n      oplogCriteria.push({\n        $or: [\n          { ns: /^admin\\.\\$cmd/ },\n          {\n            ns: {\n              $in: this._oplogOptions.includeCollections.map(\n                (collName: string) => `${this._dbName}.${collName}`\n              ),\n            },\n          },\n        ],\n      });\n    } else {\n      oplogCriteria.push({\n        ns: nsRegex,\n      });\n    }\n    if(lastProcessedTS) {\n      oplogCriteria.push({\n        ts: { $gt: lastProcessedTS },\n      });\n    }\n\n    return {\n      $and: oplogCriteria,\n    };\n  }\n\n  async stop(): Promise<void> {\n    if (this._stopped) return;\n    this._stopped = true;\n    if (this._tailHandle) {\n      await this._tailHandle.stop();\n    }\n  }\n\n  async _onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    if (this._stopped) {\n      throw new Error(\"Called onOplogEntry on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    const originalCallback = callback;\n\n    /**\n     * This depends on AsynchronousQueue tasks being wrapped in `bindEnvironment` too.\n     *\n     * @todo Check after we simplify the `bindEnvironment` implementation if we can remove the second wrap.\n     */\n    callback = Meteor.bindEnvironment(\n      function (notification: any) {\n        originalCallback(notification);\n      },\n      // @ts-ignore\n      function (err) {\n        Meteor._debug(\"Error in oplog callback\", err);\n      }\n    );\n\n    const listenHandle = this._crossbar.listen(trigger, callback);\n    return {\n      stop: async function () {\n        await listenHandle.stop();\n      }\n    };\n  }\n\n  onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    return this._onOplogEntry(trigger, callback);\n  }\n\n  onSkippedEntries(callback: Function): { stop: () => void } {\n    if (this._stopped) {\n      throw new Error(\"Called onSkippedEntries on stopped handle!\");\n    }\n    return this._onSkippedEntriesHook.register(callback);\n  }\n\n  async _waitUntilCaughtUp(): Promise<void> {\n    if (this._stopped) {\n      throw new Error(\"Called waitUntilCaughtUp on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    let lastEntry: OplogEntry | null = null;\n\n    while (!this._stopped) {\n      const oplogSelector = this._getOplogSelector();\n      try {\n        lastEntry = await this._oplogLastEntryConnection.findOneAsync(\n          OPLOG_COLLECTION,\n          oplogSelector,\n          { projection: { ts: 1 }, sort: { $natural: -1 } }\n        );\n        break;\n      } catch (e) {\n        Meteor._debug(\"Got exception while reading last entry\", e);\n        // @ts-ignore\n        await Meteor.sleep(100);\n      }\n    }\n\n    if (this._stopped) return;\n\n    if (!lastEntry) return;\n\n    const ts = lastEntry.ts;\n    if (!ts) {\n      throw Error(\"oplog entry without ts: \" + JSON.stringify(lastEntry));\n    }\n\n    if (this._lastProcessedTS && ts.lessThanOrEqual(this._lastProcessedTS)) {\n      return;\n    }\n\n    let insertAfter = this._catchingUpResolvers.length;\n\n    while (insertAfter - 1 > 0 && this._catchingUpResolvers[insertAfter - 1].ts.greaterThan(ts)) {\n      insertAfter--;\n    }\n\n    let promiseResolver = null;\n\n    const promiseToAwait = new Promise(r => promiseResolver = r);\n\n    clearTimeout(this._resolveTimeout);\n\n    this._resolveTimeout = setTimeout(() => {\n      console.error(\"Meteor: oplog catching up took too long\", { ts });\n    }, 10000);\n\n    this._catchingUpResolvers.splice(insertAfter, 0, { ts, resolver: promiseResolver! });\n\n    await promiseToAwait;\n\n    clearTimeout(this._resolveTimeout);\n  }\n\n  async waitUntilCaughtUp(): Promise<void> {\n    return this._waitUntilCaughtUp();\n  }\n\n  async _startTailing(): Promise<void> {\n    const mongodbUri = require('mongodb-uri');\n    if (mongodbUri.parse(this._oplogUrl).database !== 'local') {\n      throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n    }\n\n    this._oplogTailConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n    this._oplogLastEntryConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n\n    try {\n      const isMasterDoc = await this._oplogLastEntryConnection!.db\n        .admin()\n        .command({ ismaster: 1 });\n\n      if (!(isMasterDoc && isMasterDoc.setName)) {\n        throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n      }\n\n      const lastOplogEntry = await this._oplogLastEntryConnection.findOneAsync(\n        OPLOG_COLLECTION,\n        {},\n        { sort: { $natural: -1 }, projection: { ts: 1 } }\n      );\n\n      const oplogSelector = this._getOplogSelector(lastOplogEntry?.ts);\n      if (lastOplogEntry) {\n        this._lastProcessedTS = lastOplogEntry.ts;\n      }\n\n      const cursorDescription = new CursorDescription(\n        OPLOG_COLLECTION,\n        oplogSelector,\n        { tailable: true }\n      );\n\n      this._tailHandle = this._oplogTailConnection.tail(\n        cursorDescription,\n        (doc: any) => {\n          this._entryQueue.push(doc);\n          this._maybeStartWorker();\n        },\n        TAIL_TIMEOUT\n      );\n\n      this._readyPromiseResolver!();\n    } catch (error) {\n      console.error('Error in _startTailing:', error);\n      throw error;\n    }\n  }\n\n  private _maybeStartWorker(): void {\n    if (this._workerPromise) return;\n    this._workerActive = true;\n\n    // Convert to a proper promise-based queue processor\n    this._workerPromise = (async () => {\n      try {\n        while (!this._stopped && !this._entryQueue.isEmpty()) {\n          // Are we too far behind? Just tell our observers that they need to\n          // repoll, and drop our queue.\n          if (this._entryQueue.length > TOO_FAR_BEHIND) {\n            const lastEntry = this._entryQueue.pop();\n            this._entryQueue.clear();\n\n            this._onSkippedEntriesHook.each((callback: Function) => {\n              callback();\n              return true;\n            });\n\n            // Free any waitUntilCaughtUp() calls that were waiting for us to\n            // pass something that we just skipped.\n            this._setLastProcessedTS(lastEntry.ts);\n            continue;\n          }\n\n          // Process next batch from the queue\n          const doc = this._entryQueue.shift();\n\n          try {\n            await handleDoc(this, doc);\n            // Process any waiting fence callbacks\n            if (doc.ts) {\n              this._setLastProcessedTS(doc.ts);\n            }\n          } catch (e) {\n            // Keep processing queue even if one entry fails\n            console.error('Error processing oplog entry:', e);\n          }\n        }\n      } finally {\n        this._workerPromise = null;\n        this._workerActive = false;\n      }\n    })();\n  }\n\n  _setLastProcessedTS(ts: any): void {\n    this._lastProcessedTS = ts;\n    while (!isEmpty(this._catchingUpResolvers) && this._catchingUpResolvers[0].ts.lessThanOrEqual(this._lastProcessedTS)) {\n      const sequencer = this._catchingUpResolvers.shift()!;\n      sequencer.resolver();\n    }\n  }\n\n  _defineTooFarBehind(value: number): void {\n    TOO_FAR_BEHIND = value;\n  }\n\n  _resetTooFarBehind(): void {\n    TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\n  }\n}\n\nexport function idForOp(op: OplogEntry): string {\n  if (op.op === 'd' || op.op === 'i') {\n    return op.o._id;\n  } else if (op.op === 'u') {\n    return op.o2._id;\n  } else if (op.op === 'c') {\n    throw Error(\"Operator 'c' doesn't supply an object with id: \" + JSON.stringify(op));\n  } else {\n    throw Error(\"Unknown op: \" + JSON.stringify(op));\n  }\n}\n\nasync function handleDoc(handle: OplogHandle, doc: OplogEntry): Promise<void> {\n  if (doc.ns === \"admin.$cmd\") {\n    if (doc.o.applyOps) {\n      // This was a successful transaction, so we need to apply the\n      // operations that were involved.\n      let nextTimestamp = doc.ts;\n      for (const op of doc.o.applyOps) {\n        // See https://github.com/meteor/meteor/issues/10420.\n        if (!op.ts) {\n          op.ts = nextTimestamp;\n          nextTimestamp = nextTimestamp.add(Long.ONE);\n        }\n        await handleDoc(handle, op);\n      }\n      return;\n    }\n    throw new Error(\"Unknown command \" + JSON.stringify(doc));\n  }\n\n  const trigger: OplogTrigger = {\n    dropCollection: false,\n    dropDatabase: false,\n    op: doc,\n  };\n\n  if (typeof doc.ns === \"string\" && doc.ns.startsWith(handle._dbName + \".\")) {\n    trigger.collection = doc.ns.slice(handle._dbName.length + 1);\n  }\n\n  // Is it a special command and the collection name is hidden\n  // somewhere in operator?\n  if (trigger.collection === \"$cmd\") {\n    if (doc.o.dropDatabase) {\n      delete trigger.collection;\n      trigger.dropDatabase = true;\n    } else if (\"drop\" in doc.o) {\n      trigger.collection = doc.o.drop;\n      trigger.dropCollection = true;\n      trigger.id = null;\n    } else if (\"create\" in doc.o && \"idIndex\" in doc.o) {\n      // A collection got implicitly created within a transaction. There's\n      // no need to do anything about it.\n    } else {\n      throw Error(\"Unknown command \" + JSON.stringify(doc));\n    }\n  } else {\n    // All other ops have an id.\n    trigger.id = idForOp(doc);\n  }\n\n  await handle._crossbar.fire(trigger);\n\n  await new Promise(resolve => setImmediate(resolve));\n}"]}}},"code":"!module.wrapAsync(async function (module, __reifyWaitForDeps__, __reify_async_result__) {\n  \"use strict\";\n  try {\n    module.export({\n      OPLOG_COLLECTION: () => OPLOG_COLLECTION,\n      OplogHandle: () => OplogHandle,\n      idForOp: () => idForOp\n    });\n    let isEmpty;\n    module.link(\"lodash.isempty\", {\n      default(v) {\n        isEmpty = v;\n      }\n    }, 0);\n    let Meteor;\n    module.link(\"meteor/meteor\", {\n      Meteor(v) {\n        Meteor = v;\n      }\n    }, 1);\n    let CursorDescription;\n    module.link(\"./cursor_description\", {\n      CursorDescription(v) {\n        CursorDescription = v;\n      }\n    }, 2);\n    let MongoConnection;\n    module.link(\"./mongo_connection\", {\n      MongoConnection(v) {\n        MongoConnection = v;\n      }\n    }, 3);\n    let NpmModuleMongodb;\n    module.link(\"meteor/npm-mongo\", {\n      NpmModuleMongodb(v) {\n        NpmModuleMongodb = v;\n      }\n    }, 4);\n    if (__reifyWaitForDeps__()) (await __reifyWaitForDeps__())();\n    const {\n      Long\n    } = NpmModuleMongodb;\n    const OPLOG_COLLECTION = 'oplog.rs';\n    let TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\n    const TAIL_TIMEOUT = +(process.env.METEOR_OPLOG_TAIL_TIMEOUT || 30000);\n    class OplogHandle {\n      constructor(oplogUrl, dbName) {\n        var _Meteor$settings, _Meteor$settings$pack, _Meteor$settings$pack2, _Meteor$settings2, _Meteor$settings2$pac, _Meteor$settings2$pac2;\n        this._oplogUrl = void 0;\n        this._dbName = void 0;\n        this._oplogLastEntryConnection = void 0;\n        this._oplogTailConnection = void 0;\n        this._oplogOptions = void 0;\n        this._stopped = void 0;\n        this._tailHandle = void 0;\n        this._readyPromiseResolver = void 0;\n        this._readyPromise = void 0;\n        this._crossbar = void 0;\n        this._catchingUpResolvers = void 0;\n        this._lastProcessedTS = void 0;\n        this._onSkippedEntriesHook = void 0;\n        this._startTrailingPromise = void 0;\n        this._resolveTimeout = void 0;\n        this._entryQueue = new Meteor._DoubleEndedQueue();\n        this._workerActive = false;\n        this._workerPromise = null;\n        this._oplogUrl = oplogUrl;\n        this._dbName = dbName;\n        this._resolveTimeout = null;\n        this._oplogLastEntryConnection = null;\n        this._oplogTailConnection = null;\n        this._stopped = false;\n        this._tailHandle = null;\n        this._readyPromiseResolver = null;\n        this._readyPromise = new Promise(r => this._readyPromiseResolver = r);\n        this._crossbar = new DDPServer._Crossbar({\n          factPackage: \"mongo-livedata\",\n          factName: \"oplog-watchers\"\n        });\n        const includeCollections = (_Meteor$settings = Meteor.settings) === null || _Meteor$settings === void 0 ? void 0 : (_Meteor$settings$pack = _Meteor$settings.packages) === null || _Meteor$settings$pack === void 0 ? void 0 : (_Meteor$settings$pack2 = _Meteor$settings$pack.mongo) === null || _Meteor$settings$pack2 === void 0 ? void 0 : _Meteor$settings$pack2.oplogIncludeCollections;\n        const excludeCollections = (_Meteor$settings2 = Meteor.settings) === null || _Meteor$settings2 === void 0 ? void 0 : (_Meteor$settings2$pac = _Meteor$settings2.packages) === null || _Meteor$settings2$pac === void 0 ? void 0 : (_Meteor$settings2$pac2 = _Meteor$settings2$pac.mongo) === null || _Meteor$settings2$pac2 === void 0 ? void 0 : _Meteor$settings2$pac2.oplogExcludeCollections;\n        if (includeCollections !== null && includeCollections !== void 0 && includeCollections.length && excludeCollections !== null && excludeCollections !== void 0 && excludeCollections.length) {\n          throw new Error(\"Can't use both mongo oplog settings oplogIncludeCollections and oplogExcludeCollections at the same time.\");\n        }\n        this._oplogOptions = {\n          includeCollections,\n          excludeCollections\n        };\n        this._catchingUpResolvers = [];\n        this._lastProcessedTS = null;\n        this._onSkippedEntriesHook = new Hook({\n          debugPrintExceptions: \"onSkippedEntries callback\"\n        });\n        this._startTrailingPromise = this._startTailing();\n      }\n      _getOplogSelector(lastProcessedTS) {\n        var _this$_oplogOptions$e, _this$_oplogOptions$i;\n        const oplogCriteria = [{\n          $or: [{\n            op: {\n              $in: [\"i\", \"u\", \"d\"]\n            }\n          }, {\n            op: \"c\",\n            \"o.drop\": {\n              $exists: true\n            }\n          }, {\n            op: \"c\",\n            \"o.dropDatabase\": 1\n          }, {\n            op: \"c\",\n            \"o.applyOps\": {\n              $exists: true\n            }\n          }]\n        }];\n        const nsRegex = new RegExp(\"^(?:\" + [\n        // @ts-ignore\n        Meteor._escapeRegExp(this._dbName + \".\"),\n        // @ts-ignore\n        Meteor._escapeRegExp(\"admin.$cmd\")].join(\"|\") + \")\");\n        if ((_this$_oplogOptions$e = this._oplogOptions.excludeCollections) !== null && _this$_oplogOptions$e !== void 0 && _this$_oplogOptions$e.length) {\n          oplogCriteria.push({\n            ns: {\n              $regex: nsRegex,\n              $nin: this._oplogOptions.excludeCollections.map(collName => \"\".concat(this._dbName, \".\").concat(collName))\n            }\n          });\n        } else if ((_this$_oplogOptions$i = this._oplogOptions.includeCollections) !== null && _this$_oplogOptions$i !== void 0 && _this$_oplogOptions$i.length) {\n          oplogCriteria.push({\n            $or: [{\n              ns: /^admin\\.\\$cmd/\n            }, {\n              ns: {\n                $in: this._oplogOptions.includeCollections.map(collName => \"\".concat(this._dbName, \".\").concat(collName))\n              }\n            }]\n          });\n        } else {\n          oplogCriteria.push({\n            ns: nsRegex\n          });\n        }\n        if (lastProcessedTS) {\n          oplogCriteria.push({\n            ts: {\n              $gt: lastProcessedTS\n            }\n          });\n        }\n        return {\n          $and: oplogCriteria\n        };\n      }\n      async stop() {\n        if (this._stopped) return;\n        this._stopped = true;\n        if (this._tailHandle) {\n          await this._tailHandle.stop();\n        }\n      }\n      async _onOplogEntry(trigger, callback) {\n        if (this._stopped) {\n          throw new Error(\"Called onOplogEntry on stopped handle!\");\n        }\n        await this._readyPromise;\n        const originalCallback = callback;\n        /**\n         * This depends on AsynchronousQueue tasks being wrapped in `bindEnvironment` too.\n         *\n         * @todo Check after we simplify the `bindEnvironment` implementation if we can remove the second wrap.\n         */\n        callback = Meteor.bindEnvironment(function (notification) {\n          originalCallback(notification);\n        },\n        // @ts-ignore\n        function (err) {\n          Meteor._debug(\"Error in oplog callback\", err);\n        });\n        const listenHandle = this._crossbar.listen(trigger, callback);\n        return {\n          stop: async function () {\n            await listenHandle.stop();\n          }\n        };\n      }\n      onOplogEntry(trigger, callback) {\n        return this._onOplogEntry(trigger, callback);\n      }\n      onSkippedEntries(callback) {\n        if (this._stopped) {\n          throw new Error(\"Called onSkippedEntries on stopped handle!\");\n        }\n        return this._onSkippedEntriesHook.register(callback);\n      }\n      async _waitUntilCaughtUp() {\n        if (this._stopped) {\n          throw new Error(\"Called waitUntilCaughtUp on stopped handle!\");\n        }\n        await this._readyPromise;\n        let lastEntry = null;\n        while (!this._stopped) {\n          const oplogSelector = this._getOplogSelector();\n          try {\n            lastEntry = await this._oplogLastEntryConnection.findOneAsync(OPLOG_COLLECTION, oplogSelector, {\n              projection: {\n                ts: 1\n              },\n              sort: {\n                $natural: -1\n              }\n            });\n            break;\n          } catch (e) {\n            Meteor._debug(\"Got exception while reading last entry\", e);\n            // @ts-ignore\n            await Meteor.sleep(100);\n          }\n        }\n        if (this._stopped) return;\n        if (!lastEntry) return;\n        const ts = lastEntry.ts;\n        if (!ts) {\n          throw Error(\"oplog entry without ts: \" + JSON.stringify(lastEntry));\n        }\n        if (this._lastProcessedTS && ts.lessThanOrEqual(this._lastProcessedTS)) {\n          return;\n        }\n        let insertAfter = this._catchingUpResolvers.length;\n        while (insertAfter - 1 > 0 && this._catchingUpResolvers[insertAfter - 1].ts.greaterThan(ts)) {\n          insertAfter--;\n        }\n        let promiseResolver = null;\n        const promiseToAwait = new Promise(r => promiseResolver = r);\n        clearTimeout(this._resolveTimeout);\n        this._resolveTimeout = setTimeout(() => {\n          console.error(\"Meteor: oplog catching up took too long\", {\n            ts\n          });\n        }, 10000);\n        this._catchingUpResolvers.splice(insertAfter, 0, {\n          ts,\n          resolver: promiseResolver\n        });\n        await promiseToAwait;\n        clearTimeout(this._resolveTimeout);\n      }\n      async waitUntilCaughtUp() {\n        return this._waitUntilCaughtUp();\n      }\n      async _startTailing() {\n        const mongodbUri = require('mongodb-uri');\n        if (mongodbUri.parse(this._oplogUrl).database !== 'local') {\n          throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n        }\n        this._oplogTailConnection = new MongoConnection(this._oplogUrl, {\n          maxPoolSize: 1,\n          minPoolSize: 1\n        });\n        this._oplogLastEntryConnection = new MongoConnection(this._oplogUrl, {\n          maxPoolSize: 1,\n          minPoolSize: 1\n        });\n        try {\n          const isMasterDoc = await this._oplogLastEntryConnection.db.admin().command({\n            ismaster: 1\n          });\n          if (!(isMasterDoc && isMasterDoc.setName)) {\n            throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n          }\n          const lastOplogEntry = await this._oplogLastEntryConnection.findOneAsync(OPLOG_COLLECTION, {}, {\n            sort: {\n              $natural: -1\n            },\n            projection: {\n              ts: 1\n            }\n          });\n          const oplogSelector = this._getOplogSelector(lastOplogEntry === null || lastOplogEntry === void 0 ? void 0 : lastOplogEntry.ts);\n          if (lastOplogEntry) {\n            this._lastProcessedTS = lastOplogEntry.ts;\n          }\n          const cursorDescription = new CursorDescription(OPLOG_COLLECTION, oplogSelector, {\n            tailable: true\n          });\n          this._tailHandle = this._oplogTailConnection.tail(cursorDescription, doc => {\n            this._entryQueue.push(doc);\n            this._maybeStartWorker();\n          }, TAIL_TIMEOUT);\n          this._readyPromiseResolver();\n        } catch (error) {\n          console.error('Error in _startTailing:', error);\n          throw error;\n        }\n      }\n      _maybeStartWorker() {\n        if (this._workerPromise) return;\n        this._workerActive = true;\n        // Convert to a proper promise-based queue processor\n        this._workerPromise = (async () => {\n          try {\n            while (!this._stopped && !this._entryQueue.isEmpty()) {\n              // Are we too far behind? Just tell our observers that they need to\n              // repoll, and drop our queue.\n              if (this._entryQueue.length > TOO_FAR_BEHIND) {\n                const lastEntry = this._entryQueue.pop();\n                this._entryQueue.clear();\n                this._onSkippedEntriesHook.each(callback => {\n                  callback();\n                  return true;\n                });\n                // Free any waitUntilCaughtUp() calls that were waiting for us to\n                // pass something that we just skipped.\n                this._setLastProcessedTS(lastEntry.ts);\n                continue;\n              }\n              // Process next batch from the queue\n              const doc = this._entryQueue.shift();\n              try {\n                await handleDoc(this, doc);\n                // Process any waiting fence callbacks\n                if (doc.ts) {\n                  this._setLastProcessedTS(doc.ts);\n                }\n              } catch (e) {\n                // Keep processing queue even if one entry fails\n                console.error('Error processing oplog entry:', e);\n              }\n            }\n          } finally {\n            this._workerPromise = null;\n            this._workerActive = false;\n          }\n        })();\n      }\n      _setLastProcessedTS(ts) {\n        this._lastProcessedTS = ts;\n        while (!isEmpty(this._catchingUpResolvers) && this._catchingUpResolvers[0].ts.lessThanOrEqual(this._lastProcessedTS)) {\n          const sequencer = this._catchingUpResolvers.shift();\n          sequencer.resolver();\n        }\n      }\n      _defineTooFarBehind(value) {\n        TOO_FAR_BEHIND = value;\n      }\n      _resetTooFarBehind() {\n        TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\n      }\n    }\n    function idForOp(op) {\n      if (op.op === 'd' || op.op === 'i') {\n        return op.o._id;\n      } else if (op.op === 'u') {\n        return op.o2._id;\n      } else if (op.op === 'c') {\n        throw Error(\"Operator 'c' doesn't supply an object with id: \" + JSON.stringify(op));\n      } else {\n        throw Error(\"Unknown op: \" + JSON.stringify(op));\n      }\n    }\n    async function handleDoc(handle, doc) {\n      if (doc.ns === \"admin.$cmd\") {\n        if (doc.o.applyOps) {\n          // This was a successful transaction, so we need to apply the\n          // operations that were involved.\n          let nextTimestamp = doc.ts;\n          for (const op of doc.o.applyOps) {\n            // See https://github.com/meteor/meteor/issues/10420.\n            if (!op.ts) {\n              op.ts = nextTimestamp;\n              nextTimestamp = nextTimestamp.add(Long.ONE);\n            }\n            await handleDoc(handle, op);\n          }\n          return;\n        }\n        throw new Error(\"Unknown command \" + JSON.stringify(doc));\n      }\n      const trigger = {\n        dropCollection: false,\n        dropDatabase: false,\n        op: doc\n      };\n      if (typeof doc.ns === \"string\" && doc.ns.startsWith(handle._dbName + \".\")) {\n        trigger.collection = doc.ns.slice(handle._dbName.length + 1);\n      }\n      // Is it a special command and the collection name is hidden\n      // somewhere in operator?\n      if (trigger.collection === \"$cmd\") {\n        if (doc.o.dropDatabase) {\n          delete trigger.collection;\n          trigger.dropDatabase = true;\n        } else if (\"drop\" in doc.o) {\n          trigger.collection = doc.o.drop;\n          trigger.dropCollection = true;\n          trigger.id = null;\n        } else if (\"create\" in doc.o && \"idIndex\" in doc.o) {\n          // A collection got implicitly created within a transaction. There's\n          // no need to do anything about it.\n        } else {\n          throw Error(\"Unknown command \" + JSON.stringify(doc));\n        }\n      } else {\n        // All other ops have an id.\n        trigger.id = idForOp(doc);\n      }\n      await handle._crossbar.fire(trigger);\n      await new Promise(resolve => setImmediate(resolve));\n    }\n    __reify_async_result__();\n  } catch (_reifyError) {\n    return __reify_async_result__(_reifyError);\n  }\n  __reify_async_result__()\n}, {\n  self: this,\n  async: false\n});","map":{"version":3,"names":["module","export","OPLOG_COLLECTION","OplogHandle","idForOp","isEmpty","link","default","v","Meteor","CursorDescription","MongoConnection","NpmModuleMongodb","__reifyWaitForDeps__","Long","TOO_FAR_BEHIND","process","env","METEOR_OPLOG_TOO_FAR_BEHIND","TAIL_TIMEOUT","METEOR_OPLOG_TAIL_TIMEOUT","constructor","oplogUrl","dbName","_Meteor$settings","_Meteor$settings$pack","_Meteor$settings$pack2","_Meteor$settings2","_Meteor$settings2$pac","_Meteor$settings2$pac2","_oplogUrl","_dbName","_oplogLastEntryConnection","_oplogTailConnection","_oplogOptions","_stopped","_tailHandle","_readyPromiseResolver","_readyPromise","_crossbar","_catchingUpResolvers","_lastProcessedTS","_onSkippedEntriesHook","_startTrailingPromise","_resolveTimeout","_entryQueue","_DoubleEndedQueue","_workerActive","_workerPromise","Promise","r","DDPServer","_Crossbar","factPackage","factName","includeCollections","settings","packages","mongo","oplogIncludeCollections","excludeCollections","oplogExcludeCollections","length","Error","Hook","debugPrintExceptions","_startTailing","_getOplogSelector","lastProcessedTS","_this$_oplogOptions$e","_this$_oplogOptions$i","oplogCriteria","$or","op","$in","$exists","nsRegex","RegExp","_escapeRegExp","join","push","ns","$regex","$nin","map","collName","concat","ts","$gt","$and","stop","_onOplogEntry","trigger","callback","originalCallback","bindEnvironment","notification","err","_debug","listenHandle","listen","onOplogEntry","onSkippedEntries","register","_waitUntilCaughtUp","lastEntry","oplogSelector","findOneAsync","projection","sort","$natural","e","sleep","JSON","stringify","lessThanOrEqual","insertAfter","greaterThan","promiseResolver","promiseToAwait","clearTimeout","setTimeout","console","error","splice","resolver","waitUntilCaughtUp","mongodbUri","require","parse","database","maxPoolSize","minPoolSize","isMasterDoc","db","admin","command","ismaster","setName","lastOplogEntry","cursorDescription","tailable","tail","doc","_maybeStartWorker","pop","clear","each","_setLastProcessedTS","shift","handleDoc","sequencer","_defineTooFarBehind","value","_resetTooFarBehind","o","_id","o2","handle","applyOps","nextTimestamp","add","ONE","dropCollection","dropDatabase","startsWith","collection","slice","drop","id","fire","resolve","setImmediate","__reify_async_result__","_reifyError","self","async"],"sources":["packages/mongo/oplog_tailing.ts"],"sourcesContent":["import isEmpty from 'lodash.isempty';\nimport { Meteor } from 'meteor/meteor';\nimport { CursorDescription } from './cursor_description';\nimport { MongoConnection } from './mongo_connection';\n\nimport { NpmModuleMongodb } from \"meteor/npm-mongo\";\nconst { Long } = NpmModuleMongodb;\n\nexport const OPLOG_COLLECTION = 'oplog.rs';\n\nlet TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\nconst TAIL_TIMEOUT = +(process.env.METEOR_OPLOG_TAIL_TIMEOUT || 30000);\n\nexport interface OplogEntry {\n  op: string;\n  o: any;\n  o2?: any;\n  ts: any;\n  ns: string;\n}\n\nexport interface CatchingUpResolver {\n  ts: any;\n  resolver: () => void;\n}\n\nexport interface OplogTrigger {\n  dropCollection: boolean;\n  dropDatabase: boolean;\n  op: OplogEntry;\n  collection?: string;\n  id?: string | null;\n}\n\nexport class OplogHandle {\n  private _oplogUrl: string;\n  public _dbName: string;\n  private _oplogLastEntryConnection: MongoConnection | null;\n  private _oplogTailConnection: MongoConnection | null;\n  private _oplogOptions: {\n    excludeCollections?: string[];\n    includeCollections?: string[];\n  };\n  private _stopped: boolean;\n  private _tailHandle: any;\n  private _readyPromiseResolver: (() => void) | null;\n  private _readyPromise: Promise<void>;\n  public _crossbar: any;\n  private _catchingUpResolvers: CatchingUpResolver[];\n  private _lastProcessedTS: any;\n  private _onSkippedEntriesHook: any;\n  private _startTrailingPromise: Promise<void>;\n  private _resolveTimeout: any;\n\n  private _entryQueue = new Meteor._DoubleEndedQueue();\n  private _workerActive = false;\n  private _workerPromise: Promise<void> | null = null;\n\n  constructor(oplogUrl: string, dbName: string) {\n    this._oplogUrl = oplogUrl;\n    this._dbName = dbName;\n\n    this._resolveTimeout = null;\n    this._oplogLastEntryConnection = null;\n    this._oplogTailConnection = null;\n    this._stopped = false;\n    this._tailHandle = null;\n    this._readyPromiseResolver = null;\n    this._readyPromise = new Promise(r => this._readyPromiseResolver = r); \n    this._crossbar = new DDPServer._Crossbar({\n      factPackage: \"mongo-livedata\", factName: \"oplog-watchers\"\n    });\n\n    const includeCollections =\n      Meteor.settings?.packages?.mongo?.oplogIncludeCollections;\n    const excludeCollections =\n      Meteor.settings?.packages?.mongo?.oplogExcludeCollections;\n    if (includeCollections?.length && excludeCollections?.length) {\n      throw new Error(\n        \"Can't use both mongo oplog settings oplogIncludeCollections and oplogExcludeCollections at the same time.\"\n      );\n    }\n    this._oplogOptions = { includeCollections, excludeCollections };\n\n    this._catchingUpResolvers = [];\n    this._lastProcessedTS = null;\n\n    this._onSkippedEntriesHook = new Hook({\n      debugPrintExceptions: \"onSkippedEntries callback\"\n    });\n\n    this._startTrailingPromise = this._startTailing();\n  }\n\n  private _getOplogSelector(lastProcessedTS?: any): any {\n    const oplogCriteria: any = [\n      {\n        $or: [\n          { op: { $in: [\"i\", \"u\", \"d\"] } },\n          { op: \"c\", \"o.drop\": { $exists: true } },\n          { op: \"c\", \"o.dropDatabase\": 1 },\n          { op: \"c\", \"o.applyOps\": { $exists: true } },\n        ],\n      },\n    ];\n\n    const nsRegex = new RegExp(\n      \"^(?:\" +\n        [\n          // @ts-ignore\n          Meteor._escapeRegExp(this._dbName + \".\"),\n          // @ts-ignore\n          Meteor._escapeRegExp(\"admin.$cmd\"),\n        ].join(\"|\") +\n        \")\"\n    );\n\n    if (this._oplogOptions.excludeCollections?.length) {\n      oplogCriteria.push({\n        ns: {\n          $regex: nsRegex,\n          $nin: this._oplogOptions.excludeCollections.map(\n            (collName: string) => `${this._dbName}.${collName}`\n          ),\n        },\n      });\n    } else if (this._oplogOptions.includeCollections?.length) {\n      oplogCriteria.push({\n        $or: [\n          { ns: /^admin\\.\\$cmd/ },\n          {\n            ns: {\n              $in: this._oplogOptions.includeCollections.map(\n                (collName: string) => `${this._dbName}.${collName}`\n              ),\n            },\n          },\n        ],\n      });\n    } else {\n      oplogCriteria.push({\n        ns: nsRegex,\n      });\n    }\n    if(lastProcessedTS) {\n      oplogCriteria.push({\n        ts: { $gt: lastProcessedTS },\n      });\n    }\n\n    return {\n      $and: oplogCriteria,\n    };\n  }\n\n  async stop(): Promise<void> {\n    if (this._stopped) return;\n    this._stopped = true;\n    if (this._tailHandle) {\n      await this._tailHandle.stop();\n    }\n  }\n\n  async _onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    if (this._stopped) {\n      throw new Error(\"Called onOplogEntry on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    const originalCallback = callback;\n\n    /**\n     * This depends on AsynchronousQueue tasks being wrapped in `bindEnvironment` too.\n     *\n     * @todo Check after we simplify the `bindEnvironment` implementation if we can remove the second wrap.\n     */\n    callback = Meteor.bindEnvironment(\n      function (notification: any) {\n        originalCallback(notification);\n      },\n      // @ts-ignore\n      function (err) {\n        Meteor._debug(\"Error in oplog callback\", err);\n      }\n    );\n\n    const listenHandle = this._crossbar.listen(trigger, callback);\n    return {\n      stop: async function () {\n        await listenHandle.stop();\n      }\n    };\n  }\n\n  onOplogEntry(trigger: OplogTrigger, callback: Function): Promise<{ stop: () => Promise<void> }> {\n    return this._onOplogEntry(trigger, callback);\n  }\n\n  onSkippedEntries(callback: Function): { stop: () => void } {\n    if (this._stopped) {\n      throw new Error(\"Called onSkippedEntries on stopped handle!\");\n    }\n    return this._onSkippedEntriesHook.register(callback);\n  }\n\n  async _waitUntilCaughtUp(): Promise<void> {\n    if (this._stopped) {\n      throw new Error(\"Called waitUntilCaughtUp on stopped handle!\");\n    }\n\n    await this._readyPromise;\n\n    let lastEntry: OplogEntry | null = null;\n\n    while (!this._stopped) {\n      const oplogSelector = this._getOplogSelector();\n      try {\n        lastEntry = await this._oplogLastEntryConnection.findOneAsync(\n          OPLOG_COLLECTION,\n          oplogSelector,\n          { projection: { ts: 1 }, sort: { $natural: -1 } }\n        );\n        break;\n      } catch (e) {\n        Meteor._debug(\"Got exception while reading last entry\", e);\n        // @ts-ignore\n        await Meteor.sleep(100);\n      }\n    }\n\n    if (this._stopped) return;\n\n    if (!lastEntry) return;\n\n    const ts = lastEntry.ts;\n    if (!ts) {\n      throw Error(\"oplog entry without ts: \" + JSON.stringify(lastEntry));\n    }\n\n    if (this._lastProcessedTS && ts.lessThanOrEqual(this._lastProcessedTS)) {\n      return;\n    }\n\n    let insertAfter = this._catchingUpResolvers.length;\n\n    while (insertAfter - 1 > 0 && this._catchingUpResolvers[insertAfter - 1].ts.greaterThan(ts)) {\n      insertAfter--;\n    }\n\n    let promiseResolver = null;\n\n    const promiseToAwait = new Promise(r => promiseResolver = r);\n\n    clearTimeout(this._resolveTimeout);\n\n    this._resolveTimeout = setTimeout(() => {\n      console.error(\"Meteor: oplog catching up took too long\", { ts });\n    }, 10000);\n\n    this._catchingUpResolvers.splice(insertAfter, 0, { ts, resolver: promiseResolver! });\n\n    await promiseToAwait;\n\n    clearTimeout(this._resolveTimeout);\n  }\n\n  async waitUntilCaughtUp(): Promise<void> {\n    return this._waitUntilCaughtUp();\n  }\n\n  async _startTailing(): Promise<void> {\n    const mongodbUri = require('mongodb-uri');\n    if (mongodbUri.parse(this._oplogUrl).database !== 'local') {\n      throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n    }\n\n    this._oplogTailConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n    this._oplogLastEntryConnection = new MongoConnection(\n      this._oplogUrl, { maxPoolSize: 1, minPoolSize: 1 }\n    );\n\n    try {\n      const isMasterDoc = await this._oplogLastEntryConnection!.db\n        .admin()\n        .command({ ismaster: 1 });\n\n      if (!(isMasterDoc && isMasterDoc.setName)) {\n        throw new Error(\"$MONGO_OPLOG_URL must be set to the 'local' database of a Mongo replica set\");\n      }\n\n      const lastOplogEntry = await this._oplogLastEntryConnection.findOneAsync(\n        OPLOG_COLLECTION,\n        {},\n        { sort: { $natural: -1 }, projection: { ts: 1 } }\n      );\n\n      const oplogSelector = this._getOplogSelector(lastOplogEntry?.ts);\n      if (lastOplogEntry) {\n        this._lastProcessedTS = lastOplogEntry.ts;\n      }\n\n      const cursorDescription = new CursorDescription(\n        OPLOG_COLLECTION,\n        oplogSelector,\n        { tailable: true }\n      );\n\n      this._tailHandle = this._oplogTailConnection.tail(\n        cursorDescription,\n        (doc: any) => {\n          this._entryQueue.push(doc);\n          this._maybeStartWorker();\n        },\n        TAIL_TIMEOUT\n      );\n\n      this._readyPromiseResolver!();\n    } catch (error) {\n      console.error('Error in _startTailing:', error);\n      throw error;\n    }\n  }\n\n  private _maybeStartWorker(): void {\n    if (this._workerPromise) return;\n    this._workerActive = true;\n\n    // Convert to a proper promise-based queue processor\n    this._workerPromise = (async () => {\n      try {\n        while (!this._stopped && !this._entryQueue.isEmpty()) {\n          // Are we too far behind? Just tell our observers that they need to\n          // repoll, and drop our queue.\n          if (this._entryQueue.length > TOO_FAR_BEHIND) {\n            const lastEntry = this._entryQueue.pop();\n            this._entryQueue.clear();\n\n            this._onSkippedEntriesHook.each((callback: Function) => {\n              callback();\n              return true;\n            });\n\n            // Free any waitUntilCaughtUp() calls that were waiting for us to\n            // pass something that we just skipped.\n            this._setLastProcessedTS(lastEntry.ts);\n            continue;\n          }\n\n          // Process next batch from the queue\n          const doc = this._entryQueue.shift();\n\n          try {\n            await handleDoc(this, doc);\n            // Process any waiting fence callbacks\n            if (doc.ts) {\n              this._setLastProcessedTS(doc.ts);\n            }\n          } catch (e) {\n            // Keep processing queue even if one entry fails\n            console.error('Error processing oplog entry:', e);\n          }\n        }\n      } finally {\n        this._workerPromise = null;\n        this._workerActive = false;\n      }\n    })();\n  }\n\n  _setLastProcessedTS(ts: any): void {\n    this._lastProcessedTS = ts;\n    while (!isEmpty(this._catchingUpResolvers) && this._catchingUpResolvers[0].ts.lessThanOrEqual(this._lastProcessedTS)) {\n      const sequencer = this._catchingUpResolvers.shift()!;\n      sequencer.resolver();\n    }\n  }\n\n  _defineTooFarBehind(value: number): void {\n    TOO_FAR_BEHIND = value;\n  }\n\n  _resetTooFarBehind(): void {\n    TOO_FAR_BEHIND = +(process.env.METEOR_OPLOG_TOO_FAR_BEHIND || 2000);\n  }\n}\n\nexport function idForOp(op: OplogEntry): string {\n  if (op.op === 'd' || op.op === 'i') {\n    return op.o._id;\n  } else if (op.op === 'u') {\n    return op.o2._id;\n  } else if (op.op === 'c') {\n    throw Error(\"Operator 'c' doesn't supply an object with id: \" + JSON.stringify(op));\n  } else {\n    throw Error(\"Unknown op: \" + JSON.stringify(op));\n  }\n}\n\nasync function handleDoc(handle: OplogHandle, doc: OplogEntry): Promise<void> {\n  if (doc.ns === \"admin.$cmd\") {\n    if (doc.o.applyOps) {\n      // This was a successful transaction, so we need to apply the\n      // operations that were involved.\n      let nextTimestamp = doc.ts;\n      for (const op of doc.o.applyOps) {\n        // See https://github.com/meteor/meteor/issues/10420.\n        if (!op.ts) {\n          op.ts = nextTimestamp;\n          nextTimestamp = nextTimestamp.add(Long.ONE);\n        }\n        await handleDoc(handle, op);\n      }\n      return;\n    }\n    throw new Error(\"Unknown command \" + JSON.stringify(doc));\n  }\n\n  const trigger: OplogTrigger = {\n    dropCollection: false,\n    dropDatabase: false,\n    op: doc,\n  };\n\n  if (typeof doc.ns === \"string\" && doc.ns.startsWith(handle._dbName + \".\")) {\n    trigger.collection = doc.ns.slice(handle._dbName.length + 1);\n  }\n\n  // Is it a special command and the collection name is hidden\n  // somewhere in operator?\n  if (trigger.collection === \"$cmd\") {\n    if (doc.o.dropDatabase) {\n      delete trigger.collection;\n      trigger.dropDatabase = true;\n    } else if (\"drop\" in doc.o) {\n      trigger.collection = doc.o.drop;\n      trigger.dropCollection = true;\n      trigger.id = null;\n    } else if (\"create\" in doc.o && \"idIndex\" in doc.o) {\n      // A collection got implicitly created within a transaction. There's\n      // no need to do anything about it.\n    } else {\n      throw Error(\"Unknown command \" + JSON.stringify(doc));\n    }\n  } else {\n    // All other ops have an id.\n    trigger.id = idForOp(doc);\n  }\n\n  await handle._crossbar.fire(trigger);\n\n  await new Promise(resolve => setImmediate(resolve));\n}"],"mappings":"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","ignoreList":[]},"sourceType":"module","externalDependencies":{},"hash":"175a1593b4f7218e123ba3efdbf901442882ef3b"}
